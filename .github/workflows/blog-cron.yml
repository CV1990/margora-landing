name: Margora CI/CD - Auto Blog & Deploy
on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 16 * * *'  # 10:00 AM MÃ©xico (UTC-6) 
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: 2. Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: 3. Evitar que Next use pnpm (solo usamos npm)
        run: rm -f pnpm-lock.yaml

      - name: 4. Instalar dependencias
        run: npm ci

      - name: 5. Generar Post (IA)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/generate-post.js

      - name: 5b. Enviar newsletter (Ãºltimo post a suscriptores)
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_FROM: ${{ secrets.RESEND_FROM }}
          SITE_URL: ${{ secrets.SITE_URL }}
        run: node scripts/send-newsletter.js
        continue-on-error: true

      - name: 6. Build de Next.js
        env:
          NEXT_PUBLIC_WEB3FORMS_KEY: ${{ secrets.NEXT_PUBLIC_WEB3FORMS_KEY }}
        run: npm run build

      - name: 7. Guardar cambios en el Repo
        run: |
          git config --global user.name "Margora AutoBot"
          git config --global user.email "bot@margora.com"
          git add data/posts.json
          git diff --staged --quiet || (git commit -m "Automated Blog Post: $(date -u +%Y-%m-%d)" && git push)

      # Si falla "chat not found": inicia el bot con /start en Telegram y usa tu chat_id en TELEGRAM_TO
      - name: 8. Notificar en Telegram
        uses: appleboy/telegram-action@master
        continue-on-error: true
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            ðŸš€ **Despliegue Exitoso: Margora**
            El bot de IA ha publicado un nuevo artÃ­culo. Vercel desplegarÃ¡ automÃ¡ticamente tras el push.
            ðŸ”— [Ver sitio](https://margora.com/#blog)