name: Margora CI/CD - Auto Blog & Deploy
# Horarios en MÃ©xico (UTC-6): 9h, 12h, 15h, 18h, 21h, 22h
on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 15 * * *'   # 9:00 AM MÃ©xico
    - cron: '0 18 * * *'   # 12:00 PM MÃ©xico
    - cron: '0 21 * * *'   # 3:00 PM MÃ©xico
    - cron: '0 0 * * *'    # 6:00 PM MÃ©xico (00:00 UTC)
    - cron: '0 3 * * *'    # 9:00 PM MÃ©xico
    - cron: '0 4 * * *'    # 10:00 PM MÃ©xico
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 0. DiagnÃ³stico de secrets
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_FROM: ${{ secrets.RESEND_FROM }}
          PODCAST_FEED_URL: ${{ secrets.PODCAST_FEED_URL }}
        run: |
          echo "::group::ComprobaciÃ³n de secrets (sin mostrar valores)"
          check() { [ -n "$1" ] && echo "  OK" || echo "  FALTA"; }
          echo -n "GEMINI_API_KEY (generar post):"; check "$GEMINI_API_KEY"
          echo -n "TURSO_DATABASE_URL (newsletter):"; check "$TURSO_DATABASE_URL"
          echo -n "TURSO_AUTH_TOKEN (newsletter):"; check "$TURSO_AUTH_TOKEN"
          echo -n "RESEND_API_KEY (enviar correos):"; check "$RESEND_API_KEY"
          echo -n "RESEND_FROM (remitente):"; check "$RESEND_FROM"
          echo -n "PODCAST_FEED_URL (newsletter podcast):"; check "$PODCAST_FEED_URL"
          echo "::endgroup::"
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "::warning::GEMINI_API_KEY no configurado: no se generarÃ¡ post nuevo. Configura en Settings â†’ Secrets â†’ Actions."
          fi
          if [ -z "$RESEND_API_KEY" ] || [ -z "$RESEND_FROM" ]; then
            echo "::warning::RESEND_API_KEY o RESEND_FROM no configurados: no se enviarÃ¡n correos del newsletter."
          fi
          if [ -z "$PODCAST_FEED_URL" ]; then
            echo "::warning::PODCAST_FEED_URL no configurado: no se enviarÃ¡ correo al subir episodios al podcast."
          fi

      - name: 1. Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: 2. Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: 3. Evitar que Next use pnpm (solo usamos npm)
        run: rm -f pnpm-lock.yaml

      - name: 4. Instalar dependencias
        run: npm ci

      - name: 5. Generar Post (IA)
        id: generate-post
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/generate-post.js
        continue-on-error: true

      - name: 5b. Enviar newsletter blog (siempre con el Ãºltimo post)
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_FROM: ${{ secrets.RESEND_FROM }}
          SITE_URL: ${{ secrets.SITE_URL }}
        run: node scripts/send-newsletter.js

      - name: 5c. Enviar newsletter podcast (si hay episodio nuevo)
        env:
          PODCAST_FEED_URL: ${{ secrets.PODCAST_FEED_URL }}
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_FROM: ${{ secrets.RESEND_FROM }}
          SITE_URL: ${{ secrets.SITE_URL }}
        run: node scripts/send-podcast-newsletter.js
        continue-on-error: true

      - name: 6. Build de Next.js
        env:
          NEXT_PUBLIC_WEB3FORMS_KEY: ${{ secrets.NEXT_PUBLIC_WEB3FORMS_KEY }}
        run: npm run build

      - name: 7. Guardar cambios en el Repo
        id: commit
        run: |
          git config --global user.name "Margora AutoBot"
          git config --global user.email "bot@margora.com"
          git add data/posts.json
          if git diff --staged --quiet; then
            echo "committed=false" >> $GITHUB_OUTPUT
            echo "No hay cambios en posts.json (no se generÃ³ post nuevo)."
          else
            git commit -m "Automated Blog Post: $(date -u +%Y-%m-%d)" && git push
            echo "committed=true" >> $GITHUB_OUTPUT
          fi

      # Solo si se generÃ³ y subiÃ³ un post nuevo
      - name: 8. Notificar en Telegram
        if: steps.commit.outputs.committed == 'true'
        uses: appleboy/telegram-action@master
        continue-on-error: true
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            ðŸš€ **Despliegue Exitoso: Margora**
            El bot de IA ha publicado un nuevo artÃ­culo. Vercel desplegarÃ¡ automÃ¡ticamente tras el push.
            ðŸ”— [Ver sitio](https://margora.com/#blog)