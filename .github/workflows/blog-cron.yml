name: Margora CI/CD - Auto Blog & Deploy
# Horario: 16:00 y 17:00 UTC = 10:00 y 11:00 AM M茅xico. Segundo horario por si GitHub no ejecuta el primero.
on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 16 * * *'
    - cron: '0 17 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout del c贸digo
        uses: actions/checkout@v4

      - name: 2. Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: 3. Evitar que Next use pnpm (solo usamos npm)
        run: rm -f pnpm-lock.yaml

      - name: 4. Instalar dependencias
        run: npm ci

      - name: 5. Generar Post (IA)
        id: generate-post
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/generate-post.js
        continue-on-error: true

      - name: 5b. Enviar newsletter (煤ltimo post a suscriptores)
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_FROM: ${{ secrets.RESEND_FROM }}
          SITE_URL: ${{ secrets.SITE_URL }}
        run: node scripts/send-newsletter.js
        continue-on-error: true

      - name: 6. Build de Next.js
        env:
          NEXT_PUBLIC_WEB3FORMS_KEY: ${{ secrets.NEXT_PUBLIC_WEB3FORMS_KEY }}
        run: npm run build

      - name: 7. Guardar cambios en el Repo
        id: commit
        run: |
          git config --global user.name "Margora AutoBot"
          git config --global user.email "bot@margora.com"
          git add data/posts.json
          if git diff --staged --quiet; then
            echo "committed=false" >> $GITHUB_OUTPUT
            echo "No hay cambios en posts.json (no se gener贸 post nuevo)."
          else
            git commit -m "Automated Blog Post: $(date -u +%Y-%m-%d)" && git push
            echo "committed=true" >> $GITHUB_OUTPUT
          fi

      # Solo si se gener贸 y subi贸 un post nuevo
      - name: 8. Notificar en Telegram
        if: steps.commit.outputs.committed == 'true'
        uses: appleboy/telegram-action@master
        continue-on-error: true
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
             **Despliegue Exitoso: Margora**
            El bot de IA ha publicado un nuevo art铆culo. Vercel desplegar谩 autom谩ticamente tras el push.
             [Ver sitio](https://margora.com/#blog)