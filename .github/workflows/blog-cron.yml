name: Margora CI/CD - Auto Blog & Deploy
on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 6 * * *' # 12:00 AM MÃ©xico aprox.
    - cron: '0 15 * * *'  # 9:00 AM MÃ©xico (UTC-6)
    - cron: '0 20 * * *'  # 2:00 PM MÃ©xico (UTC-6)
    - cron: '0 23 * * *'  # 5:00 PM MÃ©xico (UTC-6) 
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: 2. Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: 3. Instalar dependencias
        run: npm ci

      - name: 4. Generar Post (IA)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node scripts/generate-post.js

      - name: 5. Build de Next.js
        env:
          NEXT_PUBLIC_WEB3FORMS_KEY: ${{ secrets.NEXT_PUBLIC_WEB3FORMS_KEY }}
        run: npm run build

      - name: 6. Guardar cambios en el Repo
        run: |
          git config --global user.name "Margora AutoBot"
          git config --global user.email "bot@margora.com"
          git add data/posts.json
          git diff --staged --quiet || (git commit -m "Automated Blog Post: $(date -u +%Y-%m-%d)" && git push)

      # Si falla "chat not found": inicia el bot con /start en Telegram y usa tu chat_id en TELEGRAM_TO
      - name: 7. Notificar en Telegram
        uses: appleboy/telegram-action@master
        continue-on-error: true
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            ðŸš€ **Despliegue Exitoso: Margora**
            El bot de IA ha publicado un nuevo artÃ­culo. Vercel desplegarÃ¡ automÃ¡ticamente tras el push.
            ðŸ”— [Ver sitio](https://margora.com/#blog)